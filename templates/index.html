<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWLVisualizer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css"/>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../static/css/graph.css" rel="stylesheet">
    <link href="../static/css/modal.css" rel="stylesheet">
    <link href="../static/css/color_themes.css" rel="stylesheet">

</head>
<body>
<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <
                <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data">
                    <input type="file" name="file" id="fileInput">
                    <button type="submit" id="uploadBtn">Upload</button>
                </form>

            </li>
        </ul>

        <!-- INFERENCE QUERY -->
        <div class="modal fade" id="customModal" tabindex="-1" role="dialog" aria-labelledby="customModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="customModalLabel">Inference Query</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="taskSelect">Tasks</label>
                            <select class="form-control" id="taskSelect">

                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ingredientSelect">Ingredients</label>
                            <select class="form-control" id="ingredientSelect">

                            </select>
                            <button type="button" class="btn btn-sm btn-secondary mt-2" id="addIngredientField">+
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- New Modal for Graph and Table -->
        <div class="modal fade" id="graphTableModal" tabindex="-1" role="dialog" aria-labelledby="graphTableModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="graphTableModalLabel">Graph and Table</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="graphContainer"></div>
                        <table class="table mt-3">
                            <thead>
                            <tr>
                                <th scope="col" style="width: 10%;">Step</th> <!-- Adjust width as needed -->
                                <th scope="col" style="width: 55%;">Action
                                <th scope="col" style="width: 35%;">Inference</th>
                            </tr>
                            </thead>
                            <tbody id="tableBody">
                            <!-- Table rows will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="container ">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">OWLVisualizer</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse"
                        data-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-between" id="navbarSupportedContent">
                    <div class="d-flex flex-grow-0"> <!-- Hier werden die Buttons links ausgerichtet -->
                        <div class="btn-group mr-2" role="group" aria-label="Basic example">
                            <div class="d-flex flex-grow-0"> <!-- Hier werden die Buttons links ausgerichtet -->
                                <div class="btn-group mr-2" role="group" aria-label="Basic example">
                                    <button class="btn btn-primary" type="button">Load Ontology</button>
                                    <button type="button" class="btn btn-primary" data-toggle="modal"
                                            data-target="#exampleModalCenter">QueryBuilder
                                    </button>
                                    <button type="button" class="btn btn-primary"
                                            data-toggle="modal" data-target="#customModal">
                                        Custom Reasoner
                                    </button>
                                </div>
                            </div>
                        </div>
                        <form class="form-inline flex-grow-1 justify-content-center">
                            <!-- Hier wird die Suchleiste in der Mitte positioniert -->
                            <div class="input-group">
                                <input id="searchBar" type="text" class="form-control" list="datalistOptions" size="40"
                                       placeholder="Search for class or instance">
                                <datalist id="datalistOptions">
                                </datalist>
                                <div class="input-group-append">
                                    <button class="btn btn-light" id="searchButton" type="button"><i
                                            class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div class="d-flex flex-grow-0">
                            <button type="submit" class="btn btn-outline-light">
                                <i class="bi bi-justify"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>
<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Query Builder</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="query-builder-body">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title"> Choose your triple</h4>
                    </div>
                    <div class="card-body">
                        <div class="row justify-content-evenly" id="query-builder-select-row"
                             onselect="showSelectFields(this)">
                            <div class="col">
                                <select class="custom-select custom-select-sm" id="query-builder-select1"
                                        title="Choose a subject"
                                        onclick="populate_suggestions_triple(this, 1);"
                                        onchange="selectedValue(this, 1)"></select>
                            </div>
                            <div class="col">
                                <select class="custom-select custom-select-sm d-none"
                                        id="query-builder-select2"
                                        title="Choose a predicate"
                                        onclick="populate_suggestions_triple(this, 2);"
                                        onchange="selectedValue(this, 2)"></select>
                            </div>
                            <div class="col">
                                <select class="custom-select custom-select-sm d-none"
                                        id="query-builder-select3"
                                        title="Choose an object"
                                        onclick="populate_suggestions_triple(this, 3);"
                                        onchange="selectedValue(this, 3)"></select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-primary invisible" id="query-builder-add" title="Add"
                                        onclick="sendSelectedValues()"
                                >+
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="query-builder-result" class="card" style="display: none">
                    <div class="card-body">
                        <ul class="nav nav-tab" id="query-builder-nav-tab"></ul>
                        <div class="tab-content" id="query-builder-tab-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div id="vis-network" class="vis-network"></div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>

<script src="/static/js/graphviz.js"></script>
<script src="/static/js/query_builder.js"></script>
<script src="/static/js/custom_inference.js"></script>
<script src="/static/js/utility.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const autocompleteInput = document.getElementById('autocompleteInput');
        if (autocompleteInput) {
            autocompleteInput.addEventListener('input', function () {
                // Hier kannst du weitere Aktionen für die Eingabe durchführen
                console.log('Input changed:', autocompleteInput.value);
            });
        }
    });

    // Call this function whenever you want to wipe the graph

    document.addEventListener('DOMContentLoaded', function () {
        // Function to handle form submission
        document.getElementById('uploadForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent default form submission
            const formData = new FormData(this); // Create FormData object
            fetch('/upload', { // Send POST request to server
                method: 'POST',
                body: formData
            })
                .then(response => response.json()) // Parse response as JSON
                .then(data => {
                    console.log(data);
                    if (!data.error) {
                        vizGraph();
                    }
                })
                .catch(error => console.error('Error:', error)); // Log any errors
        });
    });


    document.addEventListener('DOMContentLoaded', function () {
        // Verify that the graphContainer exists
        const container = document.getElementById('graphContainer');
        if (!container) {
            console.error("Graph container not found!");
            return;
        }

        // Initialize the graph
        const data = {
            nodes: [],
            edges: []
        };
        const options = {
            edges: {
                color: {
                    inherit: false
                }
            }
        }; // Customize graph options if needed
        const network = new vis.Network(container, data, options);


        function updateGraphAndTable(graphData, tableData) {
            // Update graph
            const container = document.getElementById('graphContainer');
            if (!container) {
                console.error("Graph container not found!");
                return;
            }

            const data = {
                nodes: graphData.nodes,
                edges: graphData.edges
            };
            const options = {
                edges: {
                    color: {
                        inherit: false
                    }
                }
            }; // Customize graph options if needed
            const network = new vis.Network(container, data, options);

            // Update table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // Clear previous content
            tableData.forEach(rowData => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${rowData.col1}</td>
            <td>${rowData.col2}</td>
            <td>${rowData.col3}</td>
        `;
                tableBody.appendChild(row);
            });

            // Show the modal after a short delay to ensure the graph is rendered properly
            setTimeout(function () {
                $('#graphTableModal').modal('show');
            }, 100);
        }

        jQuery(document).ready(function ($) {
            // Function to fetch and populate tasks
            $.ajax({
                url: '/task_ingredients',
                type: 'GET',
                success: function (data) {
                    var taskSelect = $('#taskSelect');
                    $.each(data.tasks, function (index, task) {
                        taskSelect.append($('<option>', {
                            value: task,
                            text: task.split("#")[1]
                        }));
                    });
                    var ingredientSelect = $('#ingredientSelect');
                    $.each(data.ingredients, function (index, ingredient) {
                        ingredientSelect.append($("<option>", {
                            value: ingredient,
                            text: ingredient.split("#")[1]

                        }));
                    });
                }
            });
        });


        document.getElementById('addIngredientField').addEventListener('click', function () {
            var originalSelect = document.getElementById('ingredientSelect');
            var newSelect = originalSelect.cloneNode(true);
            newSelect.id = 'ingredientSelect' + Math.floor(Math.random() * 1000); // Generate unique ID for the new select
            originalSelect.parentNode.appendChild(newSelect);
        });
        $(document).on('click', '#customModal .modal-footer .btn-primary', function () {
            var task = $("#taskSelect").val();
            console.log("Task:", task);

            // Retrieve selected values from all ingredient select fields
            var ingredients = [];
            $('.modal-body .form-group select').each(function () {
                var ingredient = $(this).val();
                if (ingredient && ingredient !== task) {
                    ingredients.push(ingredient);
                }
            });

            // Log the ingredients array to check if task is included
            console.log("Ingredients:", ingredients);

            // Create a data object to send to the backend
            var data = {
                task: task,
                ingredients: ingredients
            };

            // Send an AJAX POST request to your Flask backend
            $.ajax({
                type: "POST",
                url: "/data",
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (response) {
                    // Handle the response from the server
                    const graphData = response.graphData;
                    const tableData = response.tableData;
                    updateGraphAndTable(graphData, tableData);
                },
                error: function (err) {
                    // Handle errors if any
                    console.error('There was a problem fetching data:', err);
                }
            });
        });
    });

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        $('#exampleModalCenter').on('hidden.bs.modal', function (e) {
            clearSelectedOptions();
            fetchedData = null;
        });

        $('#exampleModalCenter').on('shown.bs.modal', function () {
            const modalBody = document.getElementById("query-builder-body");
            const button = document.getElementById("query-builder-add");
            const row = document.getElementById("query-builder-select-row");
            row.addEventListener("change", function () {
                showSelectFields(this);
            });
            button.addEventListener("click", function () {
                let groupName = getTripleType(modalBody, row);
                let navItem = document.getElementById(groupName + "-navItem");
                if (navItem === null) {
                    createGraphDropDown(groupName);
                    createTabPane(groupName);
                }
                createGraphVizTabContent(row, groupName);
                createSPARQLTabContent(groupName);
            });
            $(document).on('click', '.dropdown-item', function () {
                const id = $(this).attr('id');
                let content = document.querySelector(`[aria-labelledby="${id}"]`);
                if (content) {
                    document.querySelectorAll('.tab-pane').forEach(tabPane => {
                        tabPane.style.display = "none";
                    });

                    const tabPane = content.parentNode
                    const childElements = tabPane.children;
                    for (let x = 0; x < childElements.length; x++) {
                        childElements[x].style.display = "none";
                    }

                    tabPane.style.display = "block";
                    content.style.display = "block";
                }
            });
        });
    });
</script>
</body>
</html>
